#cloud-config
package_update: true
package_upgrade: true

packages:
  - git
  - curl
  - docker.io
  - docker-compose

runcmd:
  # Clone infra repo to /opt/infra (git repository)
  - git clone ${GIT_REPO_URL} /opt/infra

  # Create app working directory
  - mkdir -p /opt/app

  # Copy rendered config files for this environment to the app directory
  - cp /opt/infra/rendered/${ENVIRONMENT}/* /opt/app/
  - cp -r /opt/infra/rendered/${ENVIRONMENT}/nginx /opt/app/

  - cd /opt/app || { echo "Failed to change to /opt/app"; exit 1; }

  # Create secrets file from cloud-init vars
  - echo "CF_API_TOKEN=${CF_API_TOKEN}" > .env

  # Create certbot directory structure before creating files
  - mkdir -p certbot
  - echo "dns_cloudflare_api_token = ${CF_API_TOKEN}" > certbot/cloudflare.ini
  - chmod 600 certbot/cloudflare.ini

  # Start stack
  - docker-compose pull
  - docker-compose up -d
