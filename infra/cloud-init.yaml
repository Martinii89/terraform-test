#cloud-config
package_update: true
package_upgrade: true

packages:
  - git
  - curl
  - docker.io
  - docker-compose

runcmd:
  # Clone infra repo
  - git clone https://github.com/your-org/infra.git /opt/infra
  - cd /opt/infra

  # Create secrets file from cloud-init vars
  - echo "CF_API_TOKEN=${CF_API_TOKEN}" > .env
  - echo "dns_cloudflare_api_token = ${CF_API_TOKEN}" > certbot/cloudflare.ini
  - chmod 600 certbot/cloudflare.ini

  # Start stack
  - docker compose pull
  - docker compose up -d
